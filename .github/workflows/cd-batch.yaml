name: CD to Cloud Run Jobs (Batch, all secrets)

on:
    workflow_dispatch:  # 手動実行のみ
    # push:
    #     branches: [main]

permissions:
    contents: read
    id-token: write

env:
    REGION: asia-northeast1
    JOB_NAME: ingest
    REGISTRY: asia-northeast1-docker.pkg.dev/stock-app-473503/stock-registry
    IMAGE_TAG: ${{ github.sha }}
    DOCKERFILE_PATH: docker/Dockerfile.ingest
    BUILD_CONTEXT: .
    RUNTIME_SERVICE_ACCOUNT: cr-jobs-runner@stock-app-473503.iam.gserviceaccount.com

jobs:
    deploy-batch:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Auth to Google Cloud (OIDC/WIF)
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
                  service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

            - name: Setup gcloud
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}

            - name: Configure Docker for Artifact Registry
              run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

            - name: Build & Push batch image
              run: |
                  set -euo pipefail
                  IMAGE=${{ env.REGISTRY }}/${{ env.JOB_NAME }}:${{ env.IMAGE_TAG }}
                  DOCKER_BUILDKIT=1 docker build -t "$IMAGE" -f "${{ env.DOCKERFILE_PATH }}" "${{ env.BUILD_CONTEXT }}"
                  docker push "$IMAGE"
                  echo "IMAGE=$IMAGE" >> $GITHUB_ENV

            - name: Create/Update Cloud Run Job
              shell: bash
              run: |
                  set -euo pipefail
                  if gcloud run jobs describe "${{ env.JOB_NAME }}" --region "${{ env.REGION }}" >/dev/null 2>&1; then
                    CMD="update"
                  else
                    CMD="create"
                  fi

                  ARGS=(
                    "--image=$IMAGE"
                    "--region=${{ env.REGION }}"
                    "--tasks=1"
                    "--max-retries=1"
                    "--task-timeout=900s"
                    "--cpu=1"
                    "--memory=512Mi"
                    --set-env-vars=GIN_MODE=release 
                    "--service-account=${{ env.RUNTIME_SERVICE_ACCOUNT }}"
                    "--add-cloudsql-instances=${{ secrets.INSTANCE_CONNECTION_NAME_FOR_DEPLOY }}"
                    "--vpc-connector=run-connector"
                    "--vpc-egress=private-ranges-only"
                    "--set-secrets=JWT_SECRET=JWT_SECRET:latest,TWELVE_DATA_API_KEY=TWELVE_DATA_API_KEY:latest,TWELVE_DATA_BASE_URL=TWELVE_DATA_BASE_URL:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest,DB_NAME=DB_NAME:latest,INSTANCE_CONNECTION_NAME=INSTANCE_CONNECTION_NAME:latest,RUN_MIGRATIONS=RUN_MIGRATIONS:latest,REDIS_HOST=REDIS_HOST:latest,REDIS_PORT=REDIS_PORT:latest,REDIS_PASSWORD=REDIS_PASSWORD:latest"
                  )

                  if [ "$CMD" = "create" ]; then
                    gcloud run jobs create "${{ env.JOB_NAME }}" "${ARGS[@]}"
                  else
                    gcloud run jobs update "${{ env.JOB_NAME }}" "${ARGS[@]}"
                  fi
