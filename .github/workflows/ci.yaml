# mainブランチへのPR時に実行されるCIワークフロー
name: CI

on:
  pull_request:
    branches: [main]

jobs:
  # ドキュメントのみの変更かどうかを判定する（PR全体の差分で判定）
  docs-check:
    name: Check changes
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.docs_check.outputs.code_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if only docs changed (PR diff)
        id: docs_check
        shell: bash
        env:
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          set -euo pipefail

          git fetch --no-tags --prune origin \
            "+refs/heads/${BASE_REF}:refs/remotes/origin/${BASE_REF}" \
            "+refs/heads/${HEAD_REF}:refs/remotes/origin/${HEAD_REF}"

          echo "Base: origin/${BASE_REF}"
          echo "Head: origin/${HEAD_REF}"

          CHANGED_FILES="$(git diff --name-only "origin/${BASE_REF}...origin/${HEAD_REF}")"
          echo "Changed files:"
          echo "${CHANGED_FILES}"

          if [ -z "${CHANGED_FILES}" ]; then
            echo "code_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if echo "${CHANGED_FILES}" | grep -qvE '\.(md|txt)$|^docs/|^LICENSE$|^\.github/PULL_REQUEST_TEMPLATE\.md$'; then
            echo "code_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "code_changed=false" >> "$GITHUB_OUTPUT"
          fi

  # 静的解析（golangci-lint）
  lint:
    name: Lint
    needs: docs-check
    if: needs.docs-check.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.6.2
          args: --timeout=5m

  # ビルド確認とテスト実行
  build-test:
    name: Build & Test
    needs: docs-check
    if: needs.docs-check.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      - name: Run build
        run: go build ./...

      - name: Run tests
        run: go test ./... -v -race -cover

  # 全CIジョブの結果を集約するゲートジョブ
  # GitHub Branch Protectionではこのジョブだけをrequiredに設定する
  ci-gate:
    name: CI Gate
    needs: [lint, build-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI results
        run: |
          LINT="${{ needs.lint.result }}"
          BUILD_TEST="${{ needs.build-test.result }}"
          echo "lint=${LINT} build-test=${BUILD_TEST}"
          if [[ "${LINT}" == "success" || "${LINT}" == "skipped" ]] && \
             [[ "${BUILD_TEST}" == "success" || "${BUILD_TEST}" == "skipped" ]]; then
            echo "CI passed"
          else
            echo "CI failed"
            exit 1
          fi